#!/bin/bash

tmux -u -2 start-server

if [ "x$1" = "x" ]; then
        echo "Usage: $0 [project] ([projectdir])?"
        exit 1
fi
project=$1
if tmux has-session -t "$project"; then
        exec tmux -u -2 attach-session -t "$project"
elif [ "x$2" = "x" ]; then
        echo "tmux session $project doesn't exist. Specify a directory"
        exit 1
fi
dir=$2

if [ ! -d $dir ]; then
        echo "$dir is not a directory, can't base a tmux session there"
        exit 1
fi

# tabs needed: shell, editor, and 
#  if rails, dbconsole, console, log/development.log

tmppwd=$PWD

cd "$dir"

tmux -u new-session -s "$project" -d
tmux -u set-option -t "$project" default-path "$dir"

tmux -u new-window -t "$project:2" -d -n editor "$EDITOR"
extra=""
if [ -e script/rails ]; then
        # rails 3
        extra=rails
        console="rails console"
        dbconsole="rails dbconsole"
elif [ -e script/migrate ]; then
        # rails 2
        extra=rails
        console="script/console"
        dbconsole="script/dbconsole"
fi
case $extra in
        rails)
                tmux -u new-window -t "$project:3" -n log "tail -f log/development.log"
                tmux -u new-window -t "$project:4" -n console "$console"
                tmux -u split-window -d -t "$project:4" -p50 "$dbconsole"
                ;;
        *)
                ;;
esac
        
cd $tmppwd

exec tmux -u -2 attach-session -t "$project"
